#+PROPERTY: header-args:clojure :tangle ../../../../../test/curbside/ml/utils/tests.clj :mkdirp yes :noweb yes :padline yes :results silent :comments link
#+OPTIONS: toc:2

#+TITLE: Test Utilities

* Table of Contents                                             :toc:noexport:
- [[#introduction][Introduction]]
  - [[#namespace-definition][Namespace Definition]]
- [[#file-utilities][File utilities]]
- [[#training-set-utilities][Training set utilities]]
- [[#numeric-equality][Numeric Equality]]

* Introduction

This file contains utility functions for testing purposes.

** Namespace Definition

#+NAME: test-fixtures namespace
#+BEGIN_SRC clojure
(ns curbside.ml.utils.tests
  (:require
   [clojure.data.csv :as csv]
   [clojure.walk :as walk]
   [conjure.core :as conjure]
   [clojure.java.io :as io])
  (:import
   [java.io File]))
#+END_SRC

* File utilities

#+BEGIN_SRC clojure
(defn create-temp-path
  [extension]
  (let [file (doto (File/createTempFile "test_" extension)
               (.deleteOnExit))]
    (.getPath file)))

(defn create-temp-csv-path
  ([]
   (create-temp-path ".csv"))
  ([content]
   (let [path (create-temp-csv-path)]
     (spit path content)
     path)))

(defn count-csv-rows
  [path]
  (with-open [reader (io/reader path)]
    (count (rest (csv/read-csv reader)))))

(defn resource-name-to-path-str
  [r]
  (.getPath (io/resource r)))
#+END_SRC

* Training set utilities

Here, we load training sets from resources.

#+BEGIN_SRC clojure
(def dummy-regression-single-label-training-set-path
  (io/resource "training-sets/dummy-regression-single-label.csv"))

(def dummy-example-weights-path (io/resource "training-sets/dummy-weights.csv"))
#+END_SRC

* Numeric Equality

#+BEGIN_SRC clojure
(defn approx=
  [x y tolerance]
  (< (Math/abs (- x y)) tolerance))
#+END_SRC

* Conjure extension

These Conjure extensions allow to mock and stub private functions. They have been initially developed in curbside-analytics.

#+BEGIN_SRC clojure
(defmacro stubbing-private
  "Allows using Conjure's `stubbing` macro with private definitions."
  [bindings & body]
  (let [kvs      (partition 2 bindings)
        privates (map first  kvs)
        stubbing (map second kvs)
        defnames (map (comp gensym name) privates)]
    `(do ~@(map (fn [x] `(defn ~x [& _#])) defnames)
         (conjure/stubbing ~(vec (interleave defnames stubbing))
           (with-redefs ~(vec (interleave privates defnames))
             ~@(walk/postwalk-replace (zipmap privates defnames) body))))))
#+END_SRC
